events { 
    worker_connections 1024; 
}

http {

    # Log formatting
    log_format compression '$remote_addr - $remote_user [$time_local] '
                           '"$request" $status $body_bytes_sent '
                           '"$http_referer" "$http_user_agent" "$gzip_ratio"'

    # Setup max header size
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 64;

    # Include types to be serverd upon for proxied requests.
    include  /etc/nginx/mime.types;

    # Request Rate limiting
    limit_req_zone $binary_remote_addr zone=searchspace:10m rate=500r/m;
    limit_req_zone $binary_remote_addr zone=tellspace:10m rate=300r/m;
    limit_req_zone $binary_remote_addr zone=admin:10m rate=10r/s;


    # Server 1: Redirect all HTTP traffic to the HTTPS server
    server {
        gzip on;
        listen 80;
        listen [::]:80;
        server_name test.irene.uprm.edu;

        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-SSL on;
        proxy_set_header    X-Forwarded-Proto $scheme;

        return 301 https://test.irene.uprm.edu$request_uri;
    }
    
    # Server 2: The proxy server responsible for redirecting all traffic inside the system
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        default_type application/json; # If no content-type then assume JSON
        server_name test.irene.uprm.edu;
        
        # SSL config
        ssl_certificate /etc/nginx/ssl/localhost.crt;
        ssl_certificate_key /etc/nginx/ssl/localhost.key;
        ssl_session_cache    shared:SSL:10m;
        ssl_session_timeout  5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK';  

        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-SSL     on;
        proxy_set_header    X-Forwarded-Proto   $scheme;
        proxy_set_header    Connection          "upgrade";
        proxy_set_header    Upgrade             $http_upgrade;

        # Enable gzip compression
        gzip on;
        gzip_min_length 256;
        gzip_proxied any;

        gzip_types
            text/plain
            text/css
            text/javascript
            application/javascript
            application/x-javascript
            application/xml
            application/json
            application/ld+json;


        # Error responses
        error_page 404 = @400; # Invalid paths are treated as bad requests

        # DNS Resolver: When services are scaled up and down, the nginx server will make sure to keep track of the changes uses round robin algorithm to proxy requests
        resolver 127.0.0.11; # Production

        # Gateway request timeouts
        proxy_connect_timeout 30s;
        # proxy_no_cache 1;

        # Notes for adding endpoints:
        # 1. DO NOT end a location block  "/" unless is the main route. The nginx DNS resolver will match container names using regex.
        # Add "/" at the end of the endpoint on the proxy_pass declaration 
        
        location / {
            return 200 'Welcome to IReNE. Naviagte to the following: \n 
            1. /admin-ui --> Administrator Dashboard.\n
            2. /searchspace-ui --> Search Space ui.\n
            3. /tellspace-ui --> Tell Space ui.';
        }

        #################### ADMIN ####################
        location /admin-ui {
            gzip_static on; # static file compression
            proxy_pass http://admin-ui/;
        }

        location /admin-server {
            limit_req zone=admin;
            proxy_pass http://admin-server/;
        }


        ################### TELLSPACE ####################
        location /tellspace-ui {
            gzip_static on; # static file compression
            proxy_pass http://tellspace-ui/;
        }

        location /tellspace-server {
            limit_req zone=tellspace burst=20 nodelay;
            proxy_pass http://tellspace-server/;
        }

        
        #################### SEARCHSPACE ####################
        location /searchspace-ui {
            gzip_static on; # static file compression
            proxy_pass http://searchspace-ui/;
        }

        location /searchspace-server {
            limit_req zone=searchspace burst=20 nodelay;
            proxy_pass http://searchspace-server/;
        }
    }
}
